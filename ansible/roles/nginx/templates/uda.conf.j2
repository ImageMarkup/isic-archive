server {
    listen {% if ssl %}443{% else %}80{% endif %};
    server_name {{ site_hostname }};

    {% if ssl %}
    ssl on;
    ssl_certificate /etc/ssl/certs/{{ site_hostname }}.pem;
    ssl_certificate_key /etc/ssl/private/{{ site_hostname }}.key;
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers 'AES128+EECDH:AES128+EDH:!aNULL';
    ssl_prefer_server_ciphers on;
    ssl_stapling on;
    ssl_stapling_verify on;
    ssl_session_cache shared:SSL:10m;
    # TODO: ssl_dhparam
    add_header Strict-Transport-Security max-age=604800;
    {% endif %}

    location / {
        proxy_pass http://localhost:{{ girder_port }};
    }

    location /fcgi-bin/iipsrv.fcgi {
        fastcgi_pass localhost:{{ iip_port }};
        fastcgi_param PATH_INFO $fastcgi_script_name;
        fastcgi_param REQUEST_METHOD $request_method;
        fastcgi_param QUERY_STRING $query_string;
        fastcgi_param CONTENT_TYPE $content_type;
        fastcgi_param CONTENT_LENGTH $content_length;
        fastcgi_param SERVER_PROTOCOL $server_protocol;
        fastcgi_param REQUEST_URI $request_uri;
    }
}

server {
    listen 80 default_server;
    server_name {% if ssl %}{{ site_hostname }}{% endif %} www.{{ site_hostname }};

    return 301 http{% if ssl %}s{% endif %}://{{ site_hostname }}$request_uri;
}

{% if ssl %}
server {
    listen 443;
    server_name www.{{ site_hostname }};

    return 301 https://{{ site_hostname }}$request_uri;
}
{% endif %}
