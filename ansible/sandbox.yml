---
- hosts: all
  gather_facts: no

  tasks:
  - name: install python 2
    raw: test -e /usr/bin/python || (apt -y update && apt install -y python2.7)
    become: yes

- name: Provision ISIC Archive
  hosts: sandbox

  vars:
    mongo_data_path: "/storage/mongodb"
    bind_node_modules: false

  pre_tasks:
    - name: Find path to storage volume
      shell: |
        readlink -f $(ls /dev/disk/by-id/nvme-Amazon_Elastic_Block_Store_{{ storage_volume_id }})
      changed_when: false
      become: yes
      register: volume_path_cmd

    - set_fact:
        volume_path: "{{ volume_path_cmd.stdout }}"

    - name: Check if volume is attached
      stat:
        path: "{{ volume_path }}"
      register: dev

    - fail:
        msg: "Volume isn't attached at {{ volume_path }}, cannot mount."
      when: not dev.stat.exists

    - name: Create partition for volume
      parted:
        device: "{{ volume_path }}"
        number: 1
        state: present
      when: dev.stat.exists
      become: yes
      become_user: root

    - name: Create filesystem for volume
      filesystem:
        dev: "{{ volume_path }}p1"
        fstype: ext4
      when: dev.stat.exists
      become: yes
      become_user: root

    - name: Add fstab entry for volume
      mount:
        path: /storage
        src: "{{ volume_path }}p1"
        fstype: ext4
        state: present
      become: yes
      become_user: root

    - name: Mount storage filesystem
      mount:
        path: /storage
        src: "{{ volume_path }}p1"
        fstype: ext4
        state: mounted
      become: yes
      become_user: root

    - name: Chown mongodb data dir
      file:
        path: /storage/mongodb
        mode: 0700
        owner: mongodb
        group: mongodb
        state: directory
      become: yes
      become_user: root

    - name: Chown Girder assetstore dir
      file:
        path: /storage/girder/assetstore
        mode: 0755
        owner: ubuntu
        group: ubuntu
        state: directory
      become: yes
      become_user: root

  roles:
    - role: isic
      isic_archive_path: "{{ ansible_user_dir }}/isic_archive"
      isic_archive_assetstore_path: "/storage/girder/assetstore"

    - role: certbot
      domain: sandbox.isic-archive.com
      email: brian.helba@kitware.com

    - role: nginx
      site_hostname: sandbox.isic-archive.com
      upstream_proxy: true
      redirect_canonical: true
      ssl: true

  post_tasks:
    - name: Activate virtualenv on login
      lineinfile:
        line: 'source {{ python_dist_path }}/bin/activate'
        path: "{{ ansible_user_dir }}/.profile"
        state: present
